# MiniCartDemo - 設計ドキュメント

本ドキュメントでは、最小限のECアプリ「MiniCartDemo」を設計するにあたっての要件・機能・アーキテクチャ等を整理しています。  
実装のためのコードは含まず、プロダクトとして必要な構造・データ・フローを記述します。

---

## 1. プロダクト概要

- **目的**:  
  - ユーザーが商品を閲覧し、カートに追加して割引計算を含む購入のイメージを簡易体験できるミニECアプリ。  
  - テスト導入やリファクタリングのサンプルケースとすることを前提とした、最小規模でのEC機能を構成。

- **特徴**:  
  - 商品一覧 → 商品詳細 → カート画面 という3画面構成。  
  - カートには商品を追加・削除でき、割引クーポンを適用可能。  
  - 本格的な会員登録や決済などは省略し、テストしやすい最低限のドメインロジック（価格計算、割引適用）を含む。

---

## 2. 機能一覧

1. **商品一覧機能**  
   - 画面に複数の商品をリスト表示。  
   - 商品ごとに「商品名 / 価格 / 簡易的なサムネイル」を閲覧可能。  
   - リストアイテムをタップすると商品詳細画面へ遷移。  
   - カートに直接追加できるボタンを配置（任意）。

2. **商品詳細機能**  
   - 選択した商品の詳細（名称 / 価格 / 説明文 / 画像など）を表示。  
   - 「カートに追加」ボタンを押すとカートにアイテムを追加。  
   - 画面上部の戻る操作で商品一覧に戻れる。

3. **カート管理機能**  
   - カート内商品を一覧表示（商品名、個数、小計金額など）。  
   - 合計金額を表示し、割引クーポンが有効な場合は割引後の金額を反映。  
   - 数量を減らす/削除する処理を可能とする（最低限、1件ずつ削除可能）。  
   - カートが空の場合は空状態を表示（例:「カートは空です」など）。

4. **クーポン割引機能**  
   - クーポンコードの入力欄を用意し、指定のコードを入力すると割引率を適用する。  
   - 例: 「DISCOUNT10」で10%割引。  
   - 無効なコードの場合は割引が適用されない。

5. **画面遷移**  
   - メイン画面（商品一覧） → 商品詳細 → カート画面 の遷移を管理。  
   - カートへのアクセスは画面上部のカートアイコンやボタンから行える。

---

## 3. データ構造

1. **Product (商品)**  
   - `id`: 文字列。一意の識別子。  
   - `name`: 商品名。  
   - `price`: 商品価格（数値）。  
   - `description`: 商品の説明文（任意）。  
   - **備考**: 最小限の属性のみ定義。画像URLなどを追加する場合は`imageUrl`などのフィールドを追加。

2. **Cart (カート)**  
   - 商品と数量のマッピング: (Product, 数量) を保持する。  
   - 割引率: クーポン適用時に決定される。  
   - 合計金額: カート内商品の合計に割引を反映した最終金額。

3. **クーポンコード**  
   - 今回は文字列で管理し、マッチするかどうかだけ判定する。  
   - `DISCOUNT10` → 10%引き、他は無効。

---

## 4. アーキテクチャ概要

本プロダクトは以下の3層を想定:

1. **Domain Layer (ドメイン層)**  
   - **Model**: `Product` のようなビジネス上のデータを表現するクラス。  
   - **Service**: カート計算や割引処理といったドメインロジックを担うクラス（例: `CartService`）。  
   - 状態を持たせず、入力(商品や数量)に応じてビジネスルールを処理する責任を持つ。

2. **Application Layer (アプリケーション層)**  
   - **State Management**: 画面全体を通してのカート状態を管理する機能（例: `CartNotifier` など）。  
   - UI側からの操作を受け取ってDomain層のサービスを呼び出し、結果をUIに反映するための中継役。

3. **UI Layer (ユーザーインターフェイス層)**  
   - 画面を構成するコンポーネント（例: `ProductListPage`, `ProductDetailPage`, `CartPage`）。  
   - Application層の状態を参照し、イベント（ボタン押下など）を伝達。  
   - UI刷新や画面遷移などフロントに特化した責務を担う。

[ UI Layer ]  <–>  [ Application Layer ]  <–>  [ Domain Layer ]

---

## 5. 画面設計（簡易フロー）

1. **ProductListPage**  
   - **レイアウト**:  
     - ヘッダー: タイトルとカートアイコン(バッジで数量を表示する例あり)。  
     - ボディ: 商品リスト（ListView / GridView等）  
   - **操作**:  
     - 商品タップ → 詳細画面へ遷移。  
     - カートアイコン → カート画面へ遷移。  
     - 「+」アイコン（または別のUI） → 商品をカートへ追加（状態更新）。  

2. **ProductDetailPage**  
   - **レイアウト**:  
     - 商品名, 価格, 説明文  
     - 「カートに追加」ボタン  
   - **操作**:  
     - 戻るボタン → リストページへ戻る。  
     - 「カートに追加」 → Domain層に依頼してカート更新 → 成功時はSnackbarなどで通知。

3. **CartPage**  
   - **レイアウト**:  
     - カートアイテムをリスト表示 (商品名 x 数量, 小計)  
     - 合計金額の表示欄  
     - クーポンコード入力欄と適用ボタン  
     - カートが空の場合はメッセージ表示  
   - **操作**:  
     - 「削除」ボタンで数量を減らす（数量が0なら削除）。  
     - クーポンコードを入力 → 割引適用 → 合計金額更新。  
     - 戻るボタンで前の画面へ戻る。

---

## 6. ユースケース例

1. **UC-1: 商品をカートに追加する**  
   - **前提**: ユーザーが商品一覧または商品詳細画面を閲覧中。  
   - **基本フロー**:  
     1. ユーザーが「カートに追加」ボタンを押す。  
     2. Application層 (CartNotifier等) を介して、Domain層 (CartService) で商品の数量を更新。  
     3. UIはカートアイコンのバッジ数やカート画面に反映。  

2. **UC-2: カート内の商品合計金額を確認する**  
   - **前提**: ユーザーがカート画面を開く。  
   - **基本フロー**:  
     1. カート画面にて、合計金額を算出 (CartServiceの`getTotalAmount`を呼び出し)。  
     2. ユーザーに合計金額が表示される。  
     3. 必要に応じてクーポンコードを入力すると割引適用が再計算される。

3. **UC-3: カートアイテムを削除 / 数量調整する**  
   - **前提**: カートにすでに商品がある。  
   - **基本フロー**:  
     1. ユーザーが商品リストの「削除」ボタンなどを押す。  
     2. Domain層で数量を1つ減らし、0になれば削除。  
     3. 画面上のカート表示が更新され、合計金額も変化。

4. **UC-4: 割引クーポンを適用する**  
   - **前提**: カート画面を表示中で、少なくとも1点の商品がカートにある。  
   - **基本フロー**:  
     1. ユーザーがクーポンコードを入力 → 「適用」ボタンを押す。  
     2. CartServiceがコードの有効性を判定 (`DISCOUNT10` なら0.1割引など)。  
     3. 合計金額が再計算され、UIに反映。

---

## 7. 開発・運用ポリシー

1. **テスト重視**  
   - ユニットテスト: ドメインロジック (CartService) の価格計算・割引判定等を検証。  
   - ウィジェットテスト: カート画面や商品一覧での状態変化を確認。  
   - リファクタリング前提: テストがカバーする範囲を広げ、コード変更の安全性を高める。

2. **データ管理**  
   - 商品データはハードコードまたは簡易JSONで管理し、外部APIなどは使わずに最小限で完結。  
   - ユーザーログイン等は実装しないか、モック機能で省略。

3. **拡張方針**  
   - 必要に応じて在庫チェック、注文確定機能、ログイン機能などを追加し、設計を拡張可能。  
   - 基本設計は「Domain / Application / UI」の3層構造を崩さず進める。

---

## 8. 想定アプリ規模・リスク

- **規模**: 商品数は少数（3～5件程度）。カート登録量も数アイテムを想定。  
- **リスク**: 通信エラーや外部連携は想定しないため、実運用レベルのエラー処理は省略。  
- **目的**: あくまでテスト導入やリファクタリングを学ぶためのミニアプリケーション。

---

## 9. 今後の拡張イメージ

- **ログイン/会員管理**: ユーザー固有のカート情報保持や履歴管理。  
- **在庫管理**: 在庫切れ商品を追加できないロジックやUIを追加。  
- **注文確定フロー**: 配送先情報、支払い方法の入力、注文履歴ページなどの追加。  
- **デザイン刷新**: 実際のECライクなUIに近づけるスタイルシート適用。
